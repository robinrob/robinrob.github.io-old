<!DOCTYPE html><html lang=en><head><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-71898998-1', 'auto');
ga('send', 'pageview');
</script><meta charset=utf-8><meta content=utf-8 name=content-type><meta content="text/html; charset=UTF-8" http-equiv=Content-Type><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width, initial-scale=1" name=viewport><meta content="Blog Post: Encoding & Decoding Swift 4 Models - Using Swift 4" s coding api for database model serialisation' name=description><meta content="Freelance developer, Edinburgh, mobile, web, AngularJS, PhoneGap, SEO, Heroku, AWS, Google Apps, JavaScript, Force.com, Salesforce" name=keywords><title>Encoding & Decoding Swift 4 Models</title><link href=https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel=stylesheet type=text/css><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel=stylesheet type=text/css><link href=/css/styles.css rel=stylesheet><link href=/img/favicon.gif rel=icon type=image/gif><link href="https://rsmith.io/blog/encoding-decoding-swift-models//" rel=canonical></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button class=navbar-toggle data-target=#bs-example-navbar-collapse-1 data-toggle=collapse type=button><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href="/"><span>Home page of Robin Smith's site</span> Home</a></li><li><a href=/#services><span>View software services that Robin Smith offers</span> Services</a></li><li><a href=/#projects><span>View projects that Robin Smith has previous worked on</span> Projects</a></li><li><a href=/#endorsements><span>View Robin Smith's endorsements</span> Endorsements</a></li><li><a href=/contact><span>Use contact form to contact Robin Smith</span> Contact</a></li><li><a href=/cv><span>View Robin Smith's CV</span> CV</a></li><li><a href=/blog><span>Read Robin Smith's Software development blog</span> Blog</a></li></ul></div></div></nav><header class=intro-header><div class="container post-heading"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><h1>Encoding & Decoding Swift 4 Models</h1><h2 class=subheading>Using Swift 4's coding API for database model serialisation</h2></div></div></div></header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=main><div class=blog><article><p>Tee-ell-dee-argh: view my code examples as a <a href=https://github.com/robinrob/swift-4-model-coding/blob/master/swift-4-model-coding/CodableTest.swift>single file</a>. Running the <a href=https://github.com/robinrob/swift-4-model-coding>project</a> in xcode runs the examples and displays some output for each.</p><p>Whilst working on <a href=https://github.com/robinrob/guitar-chords>GuitarChords</a> (a personal iOS project of mine for displaying guitar chord variations) I found myself wanting to be able to pre-load the native SQLite database with data serialised in a JSON file. The motivation for this was because my app deals with a bunch of data that I&#39;ve pre-calculated and which doesn&#39;t change - variations of guitar chords. But I still wanted the database functionality for querying the records quickly.</p><p>I&#39;ve since decided that I don&#39;t need the database layer after all, as I am only dealing with ~several hundred records. After more thought I realised that the costs of having an extra persistence layer (e.g. handling app updates on users&#39; devices) in my case are not worth any potential advantages that might be gained over holding all of that data in memory, compared to simply loading the data in from the JSON on each app load.</p><p>Storing the pre-calculated data as static JSON effectively keeps the app stateless in that aspect. This also makes serialisation and de-serialisation a bit easier, as I can take full advantage of Swift 4&#39;s built-in Encoding/Decoding API.</p><p>Nevertheless it was still a fairly interesting process to get things working, so I&#39;ll give some code examples of encoding &amp; decoding objects in Swift, building up to combining serialisation with persistence, and perhaps it&#39;ll help somebody else who does need to do this, or myself in future.</p><h2>Codable</h2><p>Swift documentation is good and the best place to start for this topic is <a href=https://developer.apple.com/documentation/foundation/archives_and_serialization/encoding_and_decoding_custom_types>here</a>.</p><h3>Encoding a Struct (into JSON)</h3><p>If the instance variables of a type that you want to encode all implement the <code>Encodable</code> protocol, then Swift will encode the whole thing automatically. So for instance a Struct consisting only of standard built-in Swift types (which implement the <code>Encodable</code> protocol) can be easily converted into JSON:</p><p>code:</p><pre><code class="swift small-code">struct CodableStruct: Codable {
    var name: String
    var age: Int
}

static func encodeStructAsJSON() {
    let obj = CodableStruct(name: "Robin", age: 30)
    do {
        let encoder = JSONEncoder()
        encoder.outputFormatting = .prettyPrinted
        let data = try encoder.encode(obj)
        let json = String(data: data, encoding: .utf8)!
        print("json: \(json)")
    } catch {
        print("encoding error: \(error)")
    }
}
</code></pre><p>output:</p><pre class=plaintext><code class="plaintext small-code">json: {
  "name" : "Robin",
  "age" : 30
}
</code></pre><h3>Encoding a Class</h3><p>The same thing above also works for a Class whose instance variables all implement <code>Encodable</code>:</p><p>code:</p><pre><code class="swift small-code">class CodableClass: Codable {
    var name: String
    var age: Int

    init(name: String, age: Int) {
        self.name = name
        self.age = age
    }
}

static func encodeClassAsJSON() {
    let obj = CodableClass(name: "Robin", age: 30)
    do {
        let encoder = JSONEncoder()
        encoder.outputFormatting = .prettyPrinted
        let data = try encoder.encode(obj)
        let json = String(data: data, encoding: .utf8)!
        print("json: \(json)")
    } catch {
        print("encoding error: \(error)")
    }
}
</code></pre><p>output:</p><pre class=plaintext><code class="plaintext small-code">json: {
  "name" : "Robin",
  "age" : 30
}
</code></pre><h3>Decoding a Struct (from JSON)</h3><pre><code class="swift small-code">static func decodeStructFromJSON() {
    let json = "{\"name\":\"Robin\",\"age\":30}"

    do {
        let obj = try JSONDecoder().decode(
            CodableStruct.self,
            from: json.data(using: .utf8)!
        )
        print("obj.name: \(obj.name)")
    } catch {
        print("encoding error: \(error)")
    }
}
</code></pre><p>output:</p><pre class=plaintext><code class="plaintext small-code">obj.name: Robin
person.age: 30
</code></pre><h3>Decoding a Class</h3><pre><code class="swift small-code">static func decodeClassFromJSON() {
    let json = "{\"name\":\"Robin\",\"age\":30}"

    do {
        let obj = try JSONDecoder().decode(
            CodableClass.self,
            from: json.data(using: .utf8)!
        )
        print("obj.name: \(obj.name)")
        print("person.age: \(String(obj.age))")
    } catch {
        print("decoding error: \(error)")
    }
}
</code></pre><p>output:</p><pre class=plaintext><code class="plaintext small-code">obj.name: Robin
person.age: 30
</code></pre><h3>Encoding a Database model class</h3><p>It gets more tricky when you want to directly encode/decode a class which represents one of your database models, because we need to do custom decoding &amp; encoding. It looks like this:</p><pre><code class="swift small-code">@objc(PersonModel)
final class PersonModel: NSManagedObject, Encodable, Decodable {
    init(from decoder: Decoder) {
        super.init(
            entity: NSEntityDescription.entity(
                forEntityName: "PersonModel",
                in: context
            )!,
            insertInto: context
        )

        do {
            let container = try decoder.container(keyedBy: CodingKeys.self)
            self.name = try container.decode(type(of: self.name), forKey: .name)
            self.age = try container.decode(type(of: self.age), forKey: .age)
        } catch {
            print("decoding error: \(error)")
        }
    }

    private override init(
        entity: NSEntityDescription,
        insertInto context: NSManagedObjectContext?
    ) {
        super.init(entity: entity, insertInto: context)
    }

    func encode(to encoder: Encoder) throws {
        var container = encoder.container(keyedBy: CodingKeys.self)
        try container.encode(self.name, forKey: .name)
        try container.encode(self.age, forKey: .age)
    }

    enum CodingKeys: CodingKey {
        case name
        case age
    }
}
</code></pre><p><code>context</code> is an in-memory store (also useful for unit testing on models!) created by the following function:</p><pre><code class="swift small-code">func getBackgroundContextForTesting(
    forModelType modelType: AnyClass
) -> NSManagedObjectContext {
    let managedObjectModel = NSManagedObjectModel.mergedModel(
        from: [Bundle(for: modelType)]
    )!

    let container = NSPersistentContainer(
        name: "PersonModel",
        managedObjectModel: managedObjectModel
    )
    let description = NSPersistentStoreDescription()
    description.type = NSInMemoryStoreType

    container.persistentStoreDescriptions = [description]
    container.loadPersistentStores { (description, error) in
        precondition( description.type == NSInMemoryStoreType )

        if let error = error {
            fatalError("Creating in-memory coordinator failed \(error)")
        }
    }
    return container.newBackgroundContext()
}
</code></pre><p>Then finally, encoding the database model class:</p><pre><code class="swift small-code">static func encodeModelAsJSON() {
    let obj = NSEntityDescription.insertNewObject(
        forEntityName: "PersonModel",
        into: context
        ) as! PersonModel

    obj.name = "Robin"
    obj.age = 30

    do {
        let encoder = JSONEncoder()
        encoder.outputFormatting = .prettyPrinted
        let data = try encoder.encode(obj)
        let json = String(data: data, encoding: .utf8)!
        print("json: \(json)")
    } catch {
        print("encoding error: \(error)")
    }
}</code></pre><p>output:</p><pre class=plaintext><code class="plaintext small-code">json: {
  "name" : "Robin",
  "age" : 30
}
</code></pre><h3>Decoding a Database model class</h3><pre><code class="swift small-code">static func decodeModelFromJSON() {
    let json = "{\"name\": \"Robin\",\"age\": 30}"
    do {
        let person = try JSONDecoder().decode(
            PersonModel.self,
            from: json.data(using: .utf8)
        !)
        try context.save()
        print("person.name: \(person.name!)")
        print("person.age: \(String(person.age))")
    } catch {
        print("decoding error: \(error)")
    }
}
</code></pre>output:<pre class=plaintext><code class="plaintext small-code">obj.name: Robin
person.age: 30
</code></pre><hr><span class=post-meta>Posted by Robin Smith on February 8, 2018</span></article><hr><ul class=pager><li class=previous><a data-placement=top data-toggle=tooltip href="/blog/whats-so-fun-about-programming/" title=What s so fun about programming?'>&larr; Previous Post</a></li><li class=next><a data-placement=top data-toggle=tooltip href="/blog/deciding-what-to-learn-next/" title="Deciding What to Learn Next as a Programmer">Next Post &rarr;</a></li></ul><div id=disqus_thread></div><script>
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://rsmith-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:robin@rsmith.io target=_blank><span>Send email to Robin Smith</span> <span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/robinrob target=_blank><span>Github page of Robin Smith</span> <span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://uk.linkedin.com/in/rsmithio target=_blank><span>LinkedIn profile page of Robin Smith</span> <span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright © Robin Smith 2018</p></div></div></div></footer><script src=/js/scripts.js></script></body></html>